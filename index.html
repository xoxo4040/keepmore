<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeepMore - My Notes</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .editor-content:focus { outline: none; }
        .sidebar-item:hover .action-btn { opacity: 1; }
        .action-btn { opacity: 0; transition: opacity 0.2s; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        .folder-transition { transition: all 0.2s ease-in-out; }
        .editor-content img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
        [contenteditable]:empty:before {
            content: attr(placeholder);
            color: #d1d5db;
            cursor: text;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <!-- React & Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [folders, setFolders] = useState(() => {
                const saved = localStorage.getItem('keepmore-data');
                return saved ? JSON.parse(saved) : [
                    { id: 'f1', name: '내 메모', isOpen: true, notes: [{ id: 'n1', title: '첫 번째 메모', content: '여기에 내용을 입력하세요.' }] }
                ];
            });

            const [selectedFolderId, setSelectedFolderId] = useState(folders[0]?.id || null);
            const [selectedNoteId, setSelectedNoteId] = useState(folders[0]?.notes[0]?.id || null);

            // 실시간 로컬스토리지 저장
            useEffect(() => {
                localStorage.setItem('keepmore-data', JSON.stringify(folders));
            }, [folders]);

            const currentFolder = folders.find(f => f.id === selectedFolderId);
            const currentNote = currentFolder?.notes.find(n => n.id === selectedNoteId);

            const handleUpdateNote = (id, field, value) => {
                setFolders(prev => prev.map(folder => ({
                    ...folder,
                    notes: folder.notes.map(note => note.id === id ? { ...note, [field]: value } : note)
                })));
            };

            const toggleFolder = (folderId) => {
                setFolders(prev => prev.map(f => f.id === folderId ? { ...f, isOpen: !f.isOpen } : f));
            };

            const addFolder = () => {
                const newFolder = { id: Date.now().toString(), name: '새 폴더', isOpen: true, notes: [] };
                setFolders([...folders, newFolder]);
                setSelectedFolderId(newFolder.id);
            };

            const addNote = (folderId) => {
                const newNote = { id: 'n' + Date.now(), title: '제목 없는 메모', content: '' };
                setFolders(prev => prev.map(f => 
                    f.id === folderId ? { ...f, isOpen: true, notes: [newNote, ...f.notes] } : f
                ));
                setSelectedFolderId(folderId);
                setSelectedNoteId(newNote.id);
            };

            const deleteFolder = (e, folderId) => {
                e.stopPropagation();
                if (confirm('폴더를 삭제하시겠습니까?')) {
                    setFolders(prev => prev.filter(f => f.id !== folderId));
                    if (selectedFolderId === folderId) {
                        setSelectedFolderId(null);
                        setSelectedNoteId(null);
                    }
                }
            };

            const deleteNote = (e, folderId, noteId) => {
                e.stopPropagation();
                if (confirm('메모를 삭제하시겠습니까?')) {
                    setFolders(prev => prev.map(f => 
                        f.id === folderId ? { ...f, notes: f.notes.filter(n => n.id !== noteId) } : f
                    ));
                    if (selectedNoteId === noteId) setSelectedNoteId(null);
                }
            };

            return (
                <div className="flex h-screen overflow-hidden bg-white">
                    {/* Sidebar */}
                    <aside className="w-72 bg-[#f9f9f9] border-r border-gray-200 flex flex-col">
                        <div className="p-4 flex items-center justify-between border-b border-gray-100">
                            <h1 className="font-bold text-lg text-gray-700">KeepMore</h1>
                            <button className="w-8 h-8 rounded-full hover:bg-gray-200 flex items-center justify-center text-blue-600" title="Google Account">
                                <i className="bi bi-google"></i>
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto py-2">
                            <div className="px-3 mb-2 flex items-center justify-between group">
                                <span className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Folders</span>
                                <button onClick={addFolder} className="text-gray-400 hover:text-gray-600">
                                    <i className="bi bi-plus-lg"></i>
                                </button>
                            </div>

                            {folders.map(folder => (
                                <div key={folder.id} className="mb-1">
                                    <div 
                                        onClick={() => toggleFolder(folder.id)}
                                        className={`flex items-center px-4 py-2 cursor-pointer hover:bg-gray-200 group sidebar-item ${selectedFolderId === folder.id ? 'bg-gray-200 shadow-sm' : ''}`}
                                    >
                                        <i className={`bi ${folder.isOpen ? 'bi-chevron-down' : 'bi-chevron-right'} text-xs mr-3 text-gray-400`}></i>
                                        <i className="bi bi-folder2 text-blue-500 mr-2"></i>
                                        <span className="flex-1 text-sm font-medium truncate">{folder.name}</span>
                                        <div className="action-btn flex items-center space-x-2">
                                            <i onClick={(e) => { e.stopPropagation(); addNote(folder.id); }} className="bi bi-file-earmark-plus text-gray-400 hover:text-blue-500"></i>
                                            <i onClick={(e) => deleteFolder(e, folder.id)} className="bi bi-trash text-gray-400 hover:text-red-500"></i>
                                        </div>
                                    </div>

                                    {folder.isOpen && (
                                        <div className="ml-6 border-l border-gray-200 folder-transition">
                                            {folder.notes.map(note => (
                                                <div 
                                                    key={note.id}
                                                    onClick={() => { setSelectedFolderId(folder.id); setSelectedNoteId(note.id); }}
                                                    className={`flex items-center px-4 py-2 cursor-pointer group sidebar-item hover:bg-gray-100 ${selectedNoteId === note.id ? 'bg-blue-50 text-blue-700 font-semibold' : 'text-gray-600'}`}
                                                >
                                                    <i className="bi bi-file-text mr-2 text-xs"></i>
                                                    <span className="flex-1 text-sm truncate">{note.title || '제목 없음'}</span>
                                                    <i onClick={(e) => deleteNote(e, folder.id, note.id)} className="bi bi-x action-btn hover:text-red-500 text-lg"></i>
                                                </div>
                                            ))}
                                            {folder.notes.length === 0 && (
                                                <div className="text-xs text-gray-400 px-4 py-2 italic">메모가 없습니다</div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col bg-white">
                        {currentNote ? (
                            <React.Fragment>
                                {/* Toolbar Area */}
                                <div className="px-6 py-2 border-b border-gray-100 flex items-center space-x-4 sticky top-0 bg-white z-10">
                                    <Toolbar />
                                </div>

                                {/* Editor Area */}
                                <div className="flex-1 overflow-y-auto p-12 max-w-4xl mx-auto w-full">
                                    <input 
                                        className="w-full text-4xl font-bold mb-8 outline-none placeholder-gray-300 border-none"
                                        placeholder="Note Title"
                                        value={currentNote.title}
                                        onChange={(e) => handleUpdateNote(currentNote.id, 'title', e.target.value)}
                                    />
                                    <Editor 
                                        content={currentNote.content}
                                        onUpdate={(val) => handleUpdateNote(currentNote.id, 'content', val)}
                                    />
                                </div>
                            </React.Fragment>
                        ) : (
                            <div className="flex-1 flex items-center justify-center text-gray-400 flex-col bg-gray-50">
                                <i className="bi bi-journal-text text-6xl mb-4 opacity-20"></i>
                                <p className="text-lg">메모를 선택하거나 새로 작성해 주세요</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const Toolbar = () => {
            const format = (cmd, val) => {
                document.execCommand(cmd, false, val);
            };

            const btnClass = "w-9 h-9 flex items-center justify-center rounded-lg hover:bg-gray-200 text-gray-600 transition-colors";

            return (
                <div className="flex items-center space-x-1 p-1 bg-gray-100 rounded-xl">
                    <button className={btnClass} onClick={() => format('bold')} title="Bold"><i className="bi bi-type-bold"></i></button>
                    <button className={btnClass} onClick={() => format('italic')} title="Italic"><i className="bi bi-type-italic"></i></button>
                    <button className={btnClass} onClick={() => format('underline')} title="Underline"><i className="bi bi-type-underline"></i></button>
                    <div className="w-px h-5 bg-gray-300 mx-2"></div>
                    <button className={btnClass} onClick={() => format('insertUnorderedList')} title="Bullet List"><i className="bi bi-list-ul"></i></button>
                </div>
            );
        };

        const Editor = ({ content, onUpdate }) => {
            const editorRef = useRef(null);
            const isFirstRender = useRef(true);

            useEffect(() => {
                if (editorRef.current && isFirstRender.current) {
                    editorRef.current.innerHTML = content;
                    isFirstRender.current = false;
                }
            }, []);

            useEffect(() => {
                if (editorRef.current && !isFirstRender.current) {
                    if (editorRef.current.innerHTML !== content) {
                        editorRef.current.innerHTML = content;
                    }
                }
            }, [content]);

            const handleChange = () => {
                onUpdate(editorRef.current.innerHTML);
            };

            const handlePaste = (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file' && item.type.includes('image')) {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            
                            const selection = window.getSelection();
                            if (selection.rangeCount > 0) {
                                const range = selection.getRangeAt(0);
                                range.deleteContents();
                                range.insertNode(img);
                                range.collapse(false);
                            } else {
                                editorRef.current.appendChild(img);
                            }
                            handleChange();
                        };
                        reader.readAsDataURL(blob);
                        e.preventDefault();
                    }
                }
            };

            return (
                <div 
                    ref={editorRef}
                    contentEditable
                    onInput={handleChange}
                    onPaste={handlePaste}
                    className="editor-content w-full text-lg leading-relaxed text-gray-700 min-h-[500px]"
                    placeholder="메모를 입력하세요..."
                ></div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>